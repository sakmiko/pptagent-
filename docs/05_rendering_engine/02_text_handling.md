> 文档版本：v1.0  
> 负责人：Manus AI  
> 最后更新：2026-02-06  
> 状态：draft

# 2. 文本处理规范

文本是演示文稿的核心。渲染引擎在处理文本时，必须遵循一套严格的规范，以确保内容的可读性、样式的统一性以及对布局的适应性。`Text Fitter` 组件是实现这些规范的核心。

## 2.1 文本填充流程

当渲染引擎需要将一段文本填充到指定的文本框占位符时，它必须遵循以下流程：

1.  **样式应用**: 首先，根据 `theme_palette` 和排版规范，为文本设置正确的字体、默认字号、颜色和对齐方式。

2.  **内容填充**: 将文本内容填入 `python-pptx` 的 `text_frame` 对象。

3.  **溢出检测**: 调用一个内部函数 `check_overflow()` 来判断填充后的文本是否超出了文本框的边界。这是一个关键步骤，因为 `python-pptx` 本身不提供直接的溢出检测API。我们可以通过估算文本渲染后的大致像素尺寸，并与文本框的尺寸进行比较来实现。

4.  **动态适应**: 如果检测到溢出，`Text Fitter` 组件将按顺序启动以下自适应策略：
    - **策略一：缩小字号 (Font Size Reduction)**: 逐步减小文本的字号（例如，每次减少 0.5pt），直到文本不再溢出。为了防止字号过小影响可读性，必须设置一个最小字号下限（例如，正文不小于 14pt）。
    - **策略二：缩减行距 (Line Spacing Reduction)**: 如果缩小字号后仍然溢出，或者已经达到最小字号限制，引擎会尝试略微减小行距（例如，从 1.5 倍减小到 1.3 倍）。
    - **策略三：智能截断 (Intelligent Truncation)**: 如果以上所有方法都无效，引擎将采取最后的手段：对文本进行智能截断。它会保留尽可能多的完整句子，并在末尾添加一个标准的省略号（`...`），同时在 `speaker_notes` 中记录下被截断的全文，以供用户参考。

## 2.2 列表处理

对于 `bullet_points` 数组，渲染引擎需要循环遍历该数组，并为每个字符串在同一个文本框中创建一个新的段落（`paragraph`），并为其设置正确的列表样式（如圆点符号和缩进级别）。

## 2.3 字体与样式

- **字体映射**: 引擎内部需要维护一个字体映射表，将逻辑字体名称（如 `main_font_cn`）映射到具体的字体文件名称（如 `Microsoft YaHei`）。
- **样式继承**: 引擎应充分利用母版中定义的占位符样式。在填充内容时，应优先继承母版中的样式，只覆盖 `Final JSON` 中明确指定的样式属性（如颜色）。

## 2.4 实现要点

- **文本尺寸估算**: `check_overflow()` 的实现是难点。一个可行的方案是，使用一个轻量级的图形库（如 Pillow）在内存中创建一个虚拟画布，使用指定的字体和字号来计算文本渲染后所需的宽度和高度。
- **配置化参数**: 所有的阈值（如最小字号、行距范围）都应作为可配置的参数，而不是硬编码在代码中，以便于后续的调整和优化。

通过这套健壮的文本处理机制，渲染引擎能够极大地提高生成PPT的自动化质量，减少因内容长度不确定性而导致的布局崩溃问题。
