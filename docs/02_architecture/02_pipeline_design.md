> 文档版本：v1.0  
> 负责人：Manus AI  
> 最后更新：2026-02-06  
> 状态：draft

# 2. 流水线设计

AutoPPT Agent 的核心是一个严格定义的八阶段线性流水线。该设计将一个复杂的、端到端的任务分解为一系列独立的、可管理的阶段。每个阶段都有明确的职责、输入、输出和质量门禁，确保了整个流程的健壮性和可预测性。

## 2.1 流水线核心原则

- **线性顺序**：任务必须严格按照从 Stage 0 到 Stage 7 的顺序执行，不允许跳过任何阶段。
- **门禁机制**：每个阶段都设有“门禁”（Gatekeeping）。只有当该阶段的产出通过了预设的质量和完整性校验后，任务才能进入下一阶段。这可以防止错误在流水线中传递和放大。
- **原子性与幂等性**：每个阶段的设计都力求原子化，即完成一个独立的、完整的功能。在可能的情况下，阶段操作应具备幂等性，即多次执行相同输入的阶段会产生相同的结果。
- **可追溯性**：流水线中的每一步操作和关键决策都会被记录下来，形成可供审计和调试的任务档案。

## 2.2 八阶段详解

下面详细描述了流水线的八个阶段：

### Stage 0: 意图与约束解析 (Intent Intake)
- **输入**: 用户的原始请求，可能包含主题、目标受众、风格偏好、页数期望等。
- **处理**: 使用自然语言处理技术，从模糊的输入中提取出结构化的任务参数，如 `topic`, `must_include`, `must_exclude` 等。
- **输出**: `task_profile.json`，一份标准化的任务配置文件。
- **门禁**: `topic` 字段必须非空，否则任务无法启动。

### Stage 1: 检索规划 (Query Planning)
- **输入**: `task_profile.json`。
- **处理**: 基于核心主题，生成 3-5 个具有互补性的子查询维度（例如：现状、技术细节、发展时间线、关键人物、市场对比等），为下一步的并行搜索做准备。
- **输出**: `query_plan.json`，包含一个详细的子任务列表。
- **门禁**: 查询维度必须能覆盖主题的核心方面，且没有明显的重复。

### Stage 2: 并行搜索 (Parallel Search)
- **输入**: `query_plan.json`。
- **处理**: 启动多个并行的搜索子 Agent，每个 Agent 负责一个查询维度。它们调用外部搜索引擎（如 Tavily）获取信息，并对结果进行初步清洗和评分。
- **输出**: `evidence_bundle`，一个包含了所有搜索结果的集合，每个结果都强制附带来源 URL、标题和抓取时间。
- **门禁**: 每个查询维度至少要有一条可追溯的有效证据。

### Stage 3: 汇总与归档 (Synthesis & Archival)
- **输入**: `evidence_bundle`。
- **处理**: 对所有搜索证据进行去重、事实冲突检测和可信度分级。然后，将高质量的证据整合成一份结构化的研究摘要。
- **输出**: `research_package`，包含一份 `research_summary.md` 和结构化的证据数据。
- **门禁**: 摘要中的所有关键事实断言都必须能够回溯到原始证据。

### Stage 4: 页面规划 (Page Planning)
- **输入**: `research_package`。
- **处理**: 文本母 Agent (Text Master Agent) 负责将研究摘要分解到具体的PPT页面中，规划每一页的标题、要点和信息密度。随后，设计 Agent (Design Agent) 根据文本规格，为其匹配最合适的版式 (`layout_type`) 和视觉方案。
- **输出**: `Draft JSON`，这是一个初步的页面描述文件，包含了文本内容、布局类型和图片搜索建议 (`image_search_query`)。
- **门禁**: 每一页的 `layout_type` 和字段结构都必须符合 `02_Data_Protocol_Schema.md` 中定义的规范。

### Stage 5: 素材填充 (Asset Enrichment)
- **输入**: `Draft JSON`。
- **处理**: Build Agent 的一部分，负责根据 `image_search_query` 调用图片搜索API，下载、裁剪和预处理图片，并将处理后的本地路径 (`image_local_path`) 回填到 JSON 中。
- **输出**: `Final JSON`，一份包含了所有文本和本地图片路径的、可供渲染的最终数据文件。
- **门禁**: 如果图片下载失败，必须使用一个标准的占位图进行降级处理，不允许出现空的图片路径导致后续渲染失败。

### Stage 6: 制作与页级校验 (Build & Page Validation)
- **输入**: `Final JSON` 和 `template.pptx` 母版文件。
- **处理**: 制作 Agent (Build Agent) 调用 `python-pptx` 库，根据 `Final JSON` 的描述逐页进行渲染。每生成一页，立即进行页级校验，检查是否存在文本溢出、占位符不匹配等问题。
- **输出**: `draft_slides.json`，一个记录了已通过页级校验的页面列表。
- **门禁**: 只有当前页面通过所有页级校验，才能开始渲染下一页。

### Stage 7: 批量校正与导出 (Batch Cross-Check & Export)
- **输入**: `draft_slides.json`。
- **处理**: 为了保证演示文稿的整体连贯性，系统每完成 3 页就会触发一次“批量校正”回路，让文本、设计、制作三方 Agent 协同检查跨页的逻辑、视觉和事实一致性。所有页面都通过校验后，最终导出完整的 `.pptx` 文件。
- **输出**: `output.pptx` 文件、Web 预览所需资源以及一份 `qa_report.md`。
- **门禁**: 批量校正流程中不能存在任何 `fatal` 级别的错误。
